{"ast":null,"code":"var Buffer=require('safe-buffer').Buffer;var createHmac=require('create-hmac');var crt=require('browserify-rsa');var EC=require('elliptic').ec;var BN=require('bn.js');var parseKeys=require('parse-asn1');var curves=require(\"./curves.json\");function sign(hash,key,hashType,signType,tag){var priv=parseKeys(key);if(priv.curve){if(signType!=='ecdsa'&&signType!=='ecdsa/rsa')throw new Error('wrong private key type');return ecSign(hash,priv);}else if(priv.type==='dsa'){if(signType!=='dsa')throw new Error('wrong private key type');return dsaSign(hash,priv,hashType);}else{if(signType!=='rsa'&&signType!=='ecdsa/rsa')throw new Error('wrong private key type');}hash=Buffer.concat([tag,hash]);var len=priv.modulus.byteLength();var pad=[0,1];while(hash.length+pad.length+1<len){pad.push(0xff);}pad.push(0x00);var i=-1;while(++i<hash.length){pad.push(hash[i]);}var out=crt(pad,priv);return out;}function ecSign(hash,priv){var curveId=curves[priv.curve.join('.')];if(!curveId)throw new Error('unknown curve '+priv.curve.join('.'));var curve=new EC(curveId);var key=curve.keyFromPrivate(priv.privateKey);var out=key.sign(hash);return Buffer.from(out.toDER());}function dsaSign(hash,priv,algo){var x=priv.params.priv_key;var p=priv.params.p;var q=priv.params.q;var g=priv.params.g;var r=new BN(0);var k;var H=bits2int(hash,q).mod(q);var s=false;var kv=getKey(x,q,hash,algo);while(s===false){k=makeKey(q,kv,algo);r=makeR(g,k,p,q);s=k.invm(q).imul(H.add(x.mul(r))).mod(q);if(s.cmpn(0)===0){s=false;r=new BN(0);}}return toDER(r,s);}function toDER(r,s){r=r.toArray();s=s.toArray();if(r[0]&0x80)r=[0].concat(r);if(s[0]&0x80)s=[0].concat(s);var total=r.length+s.length+4;var res=[0x30,total,0x02,r.length];res=res.concat(r,[0x02,s.length],s);return Buffer.from(res);}function getKey(x,q,hash,algo){x=Buffer.from(x.toArray());if(x.length<q.byteLength()){var zeros=Buffer.alloc(q.byteLength()-x.length);x=Buffer.concat([zeros,x]);}var hlen=hash.length;var hbits=bits2octets(hash,q);var v=Buffer.alloc(hlen);v.fill(1);var k=Buffer.alloc(hlen);k=createHmac(algo,k).update(v).update(Buffer.from([0])).update(x).update(hbits).digest();v=createHmac(algo,k).update(v).digest();k=createHmac(algo,k).update(v).update(Buffer.from([1])).update(x).update(hbits).digest();v=createHmac(algo,k).update(v).digest();return{k:k,v:v};}function bits2int(obits,q){var bits=new BN(obits);var shift=(obits.length<<3)-q.bitLength();if(shift>0)bits.ishrn(shift);return bits;}function bits2octets(bits,q){bits=bits2int(bits,q);bits=bits.mod(q);var out=Buffer.from(bits.toArray());if(out.length<q.byteLength()){var zeros=Buffer.alloc(q.byteLength()-out.length);out=Buffer.concat([zeros,out]);}return out;}function makeKey(q,kv,algo){var t;var k;do{t=Buffer.alloc(0);while(t.length*8<q.bitLength()){kv.v=createHmac(algo,kv.k).update(kv.v).digest();t=Buffer.concat([t,kv.v]);}k=bits2int(t,q);kv.k=createHmac(algo,kv.k).update(kv.v).update(Buffer.from([0])).digest();kv.v=createHmac(algo,kv.k).update(kv.v).digest();}while(k.cmp(q)!==-1);return k;}function makeR(g,k,p,q){return g.toRed(BN.mont(p)).redPow(k).fromRed().mod(q);}module.exports=sign;module.exports.getKey=getKey;module.exports.makeKey=makeKey;","map":{"version":3,"sources":["/Users/naohirofujie/.anyenv/envs/nodenv/versions/14.5.0/lib/node_modules/expo-cli/node_modules/browserify-sign/browser/sign.js"],"names":["Buffer","require","createHmac","crt","EC","ec","BN","parseKeys","curves","sign","hash","key","hashType","signType","tag","priv","curve","Error","ecSign","type","dsaSign","concat","len","modulus","byteLength","pad","length","push","i","out","curveId","join","keyFromPrivate","privateKey","from","toDER","algo","x","params","priv_key","p","q","g","r","k","H","bits2int","mod","s","kv","getKey","makeKey","makeR","invm","imul","add","mul","cmpn","toArray","total","res","zeros","alloc","hlen","hbits","bits2octets","v","fill","update","digest","obits","bits","shift","bitLength","ishrn","t","cmp","toRed","mont","redPow","fromRed","module","exports"],"mappings":"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","sourcesContent":["// much of this based on https://github.com/indutny/self-signed/blob/gh-pages/lib/rsa.js\nvar Buffer = require('safe-buffer').Buffer\nvar createHmac = require('create-hmac')\nvar crt = require('browserify-rsa')\nvar EC = require('elliptic').ec\nvar BN = require('bn.js')\nvar parseKeys = require('parse-asn1')\nvar curves = require('./curves.json')\n\nfunction sign (hash, key, hashType, signType, tag) {\n  var priv = parseKeys(key)\n  if (priv.curve) {\n    // rsa keys can be interpreted as ecdsa ones in openssl\n    if (signType !== 'ecdsa' && signType !== 'ecdsa/rsa') throw new Error('wrong private key type')\n    return ecSign(hash, priv)\n  } else if (priv.type === 'dsa') {\n    if (signType !== 'dsa') throw new Error('wrong private key type')\n    return dsaSign(hash, priv, hashType)\n  } else {\n    if (signType !== 'rsa' && signType !== 'ecdsa/rsa') throw new Error('wrong private key type')\n  }\n  hash = Buffer.concat([tag, hash])\n  var len = priv.modulus.byteLength()\n  var pad = [0, 1]\n  while (hash.length + pad.length + 1 < len) pad.push(0xff)\n  pad.push(0x00)\n  var i = -1\n  while (++i < hash.length) pad.push(hash[i])\n\n  var out = crt(pad, priv)\n  return out\n}\n\nfunction ecSign (hash, priv) {\n  var curveId = curves[priv.curve.join('.')]\n  if (!curveId) throw new Error('unknown curve ' + priv.curve.join('.'))\n\n  var curve = new EC(curveId)\n  var key = curve.keyFromPrivate(priv.privateKey)\n  var out = key.sign(hash)\n\n  return Buffer.from(out.toDER())\n}\n\nfunction dsaSign (hash, priv, algo) {\n  var x = priv.params.priv_key\n  var p = priv.params.p\n  var q = priv.params.q\n  var g = priv.params.g\n  var r = new BN(0)\n  var k\n  var H = bits2int(hash, q).mod(q)\n  var s = false\n  var kv = getKey(x, q, hash, algo)\n  while (s === false) {\n    k = makeKey(q, kv, algo)\n    r = makeR(g, k, p, q)\n    s = k.invm(q).imul(H.add(x.mul(r))).mod(q)\n    if (s.cmpn(0) === 0) {\n      s = false\n      r = new BN(0)\n    }\n  }\n  return toDER(r, s)\n}\n\nfunction toDER (r, s) {\n  r = r.toArray()\n  s = s.toArray()\n\n  // Pad values\n  if (r[0] & 0x80) r = [0].concat(r)\n  if (s[0] & 0x80) s = [0].concat(s)\n\n  var total = r.length + s.length + 4\n  var res = [0x30, total, 0x02, r.length]\n  res = res.concat(r, [0x02, s.length], s)\n  return Buffer.from(res)\n}\n\nfunction getKey (x, q, hash, algo) {\n  x = Buffer.from(x.toArray())\n  if (x.length < q.byteLength()) {\n    var zeros = Buffer.alloc(q.byteLength() - x.length)\n    x = Buffer.concat([zeros, x])\n  }\n  var hlen = hash.length\n  var hbits = bits2octets(hash, q)\n  var v = Buffer.alloc(hlen)\n  v.fill(1)\n  var k = Buffer.alloc(hlen)\n  k = createHmac(algo, k).update(v).update(Buffer.from([0])).update(x).update(hbits).digest()\n  v = createHmac(algo, k).update(v).digest()\n  k = createHmac(algo, k).update(v).update(Buffer.from([1])).update(x).update(hbits).digest()\n  v = createHmac(algo, k).update(v).digest()\n  return { k: k, v: v }\n}\n\nfunction bits2int (obits, q) {\n  var bits = new BN(obits)\n  var shift = (obits.length << 3) - q.bitLength()\n  if (shift > 0) bits.ishrn(shift)\n  return bits\n}\n\nfunction bits2octets (bits, q) {\n  bits = bits2int(bits, q)\n  bits = bits.mod(q)\n  var out = Buffer.from(bits.toArray())\n  if (out.length < q.byteLength()) {\n    var zeros = Buffer.alloc(q.byteLength() - out.length)\n    out = Buffer.concat([zeros, out])\n  }\n  return out\n}\n\nfunction makeKey (q, kv, algo) {\n  var t\n  var k\n\n  do {\n    t = Buffer.alloc(0)\n\n    while (t.length * 8 < q.bitLength()) {\n      kv.v = createHmac(algo, kv.k).update(kv.v).digest()\n      t = Buffer.concat([t, kv.v])\n    }\n\n    k = bits2int(t, q)\n    kv.k = createHmac(algo, kv.k).update(kv.v).update(Buffer.from([0])).digest()\n    kv.v = createHmac(algo, kv.k).update(kv.v).digest()\n  } while (k.cmp(q) !== -1)\n\n  return k\n}\n\nfunction makeR (g, k, p, q) {\n  return g.toRed(BN.mont(p)).redPow(k).fromRed().mod(q)\n}\n\nmodule.exports = sign\nmodule.exports.getKey = getKey\nmodule.exports.makeKey = makeKey\n"]},"metadata":{},"sourceType":"script"}